<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM Team 智慧足跡系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const CONFIG = {
            LIFF_ID: "2008843042-HQANLx77", 
            FIREBASE: {
                apiKey: "AIzaSyD-iTmN_rwJUWbNmbBiXva52dlNKyM4fSA", 
                projectId: "lmteam-4f2db",
                authDomain: "lmteam-4f2db.firebaseapp.com",
                appId: "1:765459964596:web:765459964596"
            }
        };

        let db, auth, userProfile;
        const appId = "lmteam-footprint-v1";

        // 輔助函式：複製文字
        window.copyUrl = () => {
            const url = window.location.origin + window.location.pathname;
            const el = document.createElement('textarea');
            el.value = url;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            document.getElementById('copyHint').innerText = "✅ 已複製！請貼至 LINE 後台";
        };

        async function init() {
            const status = document.getElementById('statusText');
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                
                userProfile = await liff.getProfile();
                document.getElementById('userName').innerText = `您好，${userProfile.displayName}`;

                const app = initializeApp(CONFIG.FIREBASE);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);

                status.innerText = "連線成功，請開始打卡";
                document.querySelectorAll('.btn-punch').forEach(b => b.disabled = false);
            } catch (err) {
                const currentUrl = window.location.origin + window.location.pathname;
                status.innerHTML = `
                    <div class="text-rose-600 font-bold mb-2">網址不匹配 (404/Error)</div>
                    <div class="text-[10px] text-slate-500 mb-4">請將下方網址完整填入 LINE Developers 的 Endpoint URL：</div>
                    <div class="bg-slate-100 p-2 rounded text-[10px] text-blue-600 break-all mb-4 border border-blue-200">
                        ${currentUrl}
                    </div>
                    <button onclick="copyUrl()" class="bg-blue-600 text-white text-xs py-2 px-4 rounded-full font-bold shadow-md">
                        點我複製正確網址
                    </button>
                    <div id="copyHint" class="text-[9px] text-emerald-600 mt-2 font-bold"></div>
                `;
            }
        }

        window.doPunch = (type) => {
            const status = document.getElementById('statusText');
            const btns = document.querySelectorAll('.btn-punch');
            btns.forEach(b => b.disabled = true);
            status.innerHTML = `<span class="animate-pulse text-blue-500">地理座標傳輸中...</span>`;

            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checkins'), {
                        name: userProfile.displayName,
                        uid: userProfile.userId,
                        timestamp: serverTimestamp(),
                        type: type,
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    });
                    status.innerHTML = `<div class="text-emerald-600 font-bold text-lg">✨ ${type === 'IN' ? '上班' : '下班'}打卡成功</div>`;
                } catch (e) {
                    status.innerText = "寫入資料庫失敗";
                }
                setTimeout(() => btns.forEach(b => b.disabled = false), 2000);
            }, (err) => {
                status.innerText = "GPS 定位失敗，請授權位置權限";
                btns.forEach(b => b.disabled = false);
            }, { enableHighAccuracy: true });
        };

        window.onload = init;
    </script>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col items-center justify-center p-6 text-slate-200">
    <div class="bg-white w-full max-w-sm rounded-[3rem] shadow-2xl p-10 text-center border border-slate-700/10">
        <div class="mb-8">
            <div class="w-16 h-16 bg-blue-50 rounded-2xl mx-auto flex items-center justify-center mb-4 text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
            </div>
            <h1 class="text-2xl font-black text-slate-800">軒揚數理 教師打卡系統</h1>
            <p id="userName" class="text-slate-400 text-sm mt-1 tracking-tight">自動排錯模組啟動</p>
        </div>

        <div class="space-y-3 mb-8">
            <button id="workBtn" onclick="doPunch('IN')" disabled class="btn-punch w-full py-4 rounded-xl bg-blue-600 text-white font-bold shadow-lg active:scale-95 transition-all">上班簽到</button>
            <button id="offBtn" onclick="doPunch('OUT')" disabled class="btn-punch w-full py-4 rounded-xl bg-slate-800 text-white font-bold shadow-lg active:scale-95 transition-all">下班簽退</button>
        </div>

        <div id="statusText" class="text-xs text-slate-500 bg-slate-50 py-6 px-4 rounded-2xl min-h-[6rem] flex flex-col items-center justify-center border border-slate-100">
            偵測環境中...
        </div>
    </div>
</body>
</html>
